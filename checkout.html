<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment</title>
    <link rel="icon" href="img/logo.png" type="image/png">
    <link rel="stylesheet" href="style/style.css">
    <script src="js/script.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Icons library -->
</head>

<body class="iframe1">
    <h3>Secure Payment</h3>
    <form id="paymentForm">
        <!-- Card Number -->
        <input type="text" id="card-number" placeholder="Card Number" maxlength="19" pattern="\d{4} \d{4} \d{4} \d{4}"
            required title="Enter a valid 16-digit card number in 4 groups, e.g. 4242 4242 4242 4242" />
        <!-- Expiration Date -->
        <input type="text" id="card-exp" placeholder="MM/YY" maxlength="5" pattern="(0[1-9]|1[0-2])\/\d{2}" required
            title="Enter a valid expiration date in MM/YY format" />
        <!-- CVC -->
        <input type="text" id="card-cvc" placeholder="CVC" maxlength="4" pattern="\d{3,4}" required
            title="Enter a 3 or 4 digit CVC" />
        <button type="submit">Pay</button>
    </form>

    <div class="spinner" id="spinner" style="display:none;"></div>
    <div class="processing" id="processing" style="display:none;">Processing payment...</div>

    <script>
        const paymentForm = document.getElementById("paymentForm");
        const cardInput = document.getElementById("card-number");
        const expiryInput = document.getElementById("card-exp");
        const cvcInput = document.getElementById("card-cvc");

        paymentForm.addEventListener("submit", function (event) {
            event.preventDefault();

            const rawCard = cardInput.value.replace(/\s/g, "");
            const rawExp = expiryInput.value.trim();
            const rawCVC = cvcInput.value.trim();
            if (rawCard.length !== 16 || /\D/.test(rawCard)) {
                alert("Card number must be 16 digits.");
                cardInput.focus();
                return;
            }

            if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(rawExp)) {
                alert("Enter a valid expiry MM/YY.");
                expiryInput.focus();
                return;
            }

            if (!/^\d{3,4}$/.test(rawCVC)) {
                alert("CVC must be 3 or 4 digits.");
                cvcInput.focus();
                return;
            }

            if (rawCard !== "7777777777777777") {
                alert("Card number ivalid, plese enter a valid one.");
                cardInput.focus();
                cardInput.style.border = "2px solid red";
                return;
            }
            paymentForm.style.display = "none";
            document.getElementById("spinner").style.display = "block";
            document.getElementById("processing").style.display = "block";

            setTimeout(() => {
                parent.postMessage({ type: "PAYMENT_SUCCESS" }, "*");
            }, 2500);
        });

        // Format card number
        cardInput.addEventListener("input", () => {
            let value = cardInput.value.replace(/\D/g, "").substring(0, 16);
            cardInput.value = value.replace(/(.{4})/g, "$1 ").trim();
        });

        // Format expiry date
        expiryInput.addEventListener("input", () => {
            let value = expiryInput.value.replace(/\D/g, "");
            if (value.length > 2) value = value.substring(0, 2) + "/" + value.substring(2, 4);
            expiryInput.value = value;
        });
    </script>
</body>
</html>